<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>May We Care - Time Portal</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & Firebase Imports -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js",
        "lucide-react": "https://esm.sh/lucide-react@0.344.0"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style> 
        body { background-color: #f1f5f9; } 
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            updateProfile
        } from 'firebase/auth';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            setDoc,
            getDoc,
            updateDoc, 
            doc, 
            onSnapshot, 
            serverTimestamp, 
            deleteDoc,
            query,
            where
        } from 'firebase/firestore';
        import { Clock, User, LogIn, LogOut, Building, ShieldCheck, AlertCircle, Lock, Mail, ChevronRight, History, Trash2, Users, UserCog } from 'lucide-react';

        // =================================================================
        // CONFIGURATION SECTION - PASTE YOUR KEYS BELOW
        // =================================================================
        
const firebaseConfig = {
  apiKey: "AIzaSyCG_XoHEAzjwHROt-Ejz7NHHQZnr1frTTA",
  authDomain: "maywecaretimemanagement-40151.firebaseapp.com",
  projectId: "maywecaretimemanagement-40151",
  storageBucket: "maywecaretimemanagement-40151.firebasestorage.app",
  messagingSenderId: "643091869308",
  appId: "1:643091869308:web:6e2004a80f4c48c69c23f9",
  measurementId: "G-LK72MK382J"
};

        // MANAGER SECRET CODE (To create a manager account)
        const MANAGER_SECRET_CODE = "admin2025"; 

        // =================================================================
        // END CONFIGURATION
        // =================================================================

        // Initialize Firebase
        let app, auth, db;
        let configError = false;
        try {
            // Check if we are in the preview environment (Internal Use Only)
            if (typeof __firebase_config !== 'undefined') {
                app = initializeApp(JSON.parse(__firebase_config));
            } else if (firebaseConfig.apiKey) {
                app = initializeApp(firebaseConfig);
            } else {
                throw new Error("Missing Config");
            }
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase Config Error:", e);
            configError = true;
        }

        const appId = 'may-we-care-production'; 

        // Helper Functions
        const formatTime = (date) => date ? new Date(date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '--:--';
        const formatDate = (date) => date ? new Date(date).toLocaleDateString([], { weekday: 'short', month: 'short', day: 'numeric' }) : '-';
        const calculateDuration = (start, end) => {
          if (!start || !end) return 'In Progress';
          const diffMs = new Date(end) - new Date(start);
          const diffHrs = Math.floor((diffMs % 86400000) / 3600000);
          const diffMins = Math.round(((diffMs % 86400000) % 3600000) / 60000);
          return `${diffHrs}h ${diffMins}m`;
        };

        // --- COMPONENTS ---

        // 1. Auth Screen (Login / Register)
        const AuthScreen = ({ onLogin }) => {
            const [isRegistering, setIsRegistering] = useState(false);
            const [isManagerReg, setIsManagerReg] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [name, setName] = useState('');
            const [managerCode, setManagerCode] = useState('');
            const [error, setError] = useState(null);
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError(null);
                setLoading(true);

                try {
                    if (isRegistering) {
                        // Registration Logic
                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        const user = userCredential.user;
                        
                        // Determine Role
                        // Auto-promote Stacey Sammons to manager regardless of code
                        let role = 'staff';
                        if (name.trim().toLowerCase() === 'stacey sammons') {
                            role = 'manager';
                        } else if (isManagerReg && managerCode === MANAGER_SECRET_CODE) {
                            role = 'manager';
                        }
                        
                        // Save User Profile to Firestore
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid), {
                            uid: user.uid,
                            name: name,
                            email: email,
                            role: role,
                            createdAt: serverTimestamp()
                        });

                        // Also update Auth Profile
                        await updateProfile(user, { displayName: name });
                        
                    } else {
                        // Login Logic
                        await signInWithEmailAndPassword(auth, email, password);
                    }
                } catch (err) {
                    console.error(err);
                    let msg = "Authentication failed.";
                    if (err.code === 'auth/invalid-credential') msg = "Invalid email or password.";
                    if (err.code === 'auth/email-already-in-use') msg = "Email already registered.";
                    if (err.code === 'auth/weak-password') msg = "Password should be at least 6 characters.";
                    setError(msg);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md fade-in">
                        <div className="text-center mb-8">
                            <img src="logo.png" alt="Logo" className="h-16 w-auto mx-auto mb-4 object-contain" onError={(e) => e.target.style.display='none'} />
                            <h1 className="text-2xl font-bold text-purple-900">May We Care</h1>
                            <p className="text-slate-500">{isRegistering ? "Create your account" : "Sign in to portal"}</p>
                        </div>

                        {error && <div className="bg-red-50 text-red-600 p-3 rounded-lg mb-4 text-sm flex items-center gap-2"><AlertCircle size={16}/>{error}</div>}

                        <form onSubmit={handleSubmit} className="space-y-4">
                            {isRegistering && (
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">Full Name</label>
                                    <div className="relative">
                                        <User className="absolute left-3 top-3 text-slate-400" size={18} />
                                        <input type="text" required value={name} onChange={e => setName(e.target.value)} className="pl-10 w-full p-2 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none" placeholder="e.g. Stacey Sammons" />
                                    </div>
                                </div>
                            )}
                            
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Email Address</label>
                                <div className="relative">
                                    <Mail className="absolute left-3 top-3 text-slate-400" size={18} />
                                    <input type="email" required value={email} onChange={e => setEmail(e.target.value)} className="pl-10 w-full p-2 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none" placeholder="name@maywecare.co.uk" />
                                </div>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Password</label>
                                <div className="relative">
                                    <Lock className="absolute left-3 top-3 text-slate-400" size={18} />
                                    <input type="password" required value={password} onChange={e => setPassword(e.target.value)} className="pl-10 w-full p-2 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
                                </div>
                            </div>

                            {isRegistering && (
                                <div className="pt-4 border-t mt-4">
                                    <div className="flex items-center gap-2 mb-2">
                                        <input type="checkbox" id="mgr-check" checked={isManagerReg} onChange={e => setIsManagerReg(e.target.checked)} className="rounded text-purple-600 focus:ring-purple-500"/>
                                        <label htmlFor="mgr-check" className="text-sm font-medium text-slate-700 cursor-pointer">Register as Manager</label>
                                    </div>
                                    {isManagerReg && (
                                         <div className="animate-in fade-in">
                                            <input type="password" value={managerCode} onChange={e => setManagerCode(e.target.value)} className="w-full p-2 border rounded-lg text-sm bg-purple-50 focus:ring-2 focus:ring-purple-500 outline-none" placeholder="Enter Admin Code (admin2025)" />
                                         </div>
                                    )}
                                </div>
                            )}

                            <button disabled={loading} className="w-full bg-purple-700 hover:bg-purple-800 text-white py-2.5 rounded-lg font-medium transition-colors mt-6">
                                {loading ? "Processing..." : (isRegistering ? "Create Account" : "Sign In")}
                            </button>
                        </form>

                        <div className="mt-6 text-center text-sm text-slate-600">
                            {isRegistering ? "Already have an account? " : "New staff member? "}
                            <button onClick={() => setIsRegistering(!isRegistering)} className="text-purple-700 font-semibold hover:underline">
                                {isRegistering ? "Sign In" : "Register Here"}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // 2. Client Selection Modal
        const ClientSelectionModal = ({ clients, onConfirm, onCancel }) => (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4 backdrop-blur-sm animate-in fade-in">
              <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[80vh]">
                <div className="bg-slate-800 p-6 text-white text-center shrink-0">
                    <h3 className="text-xl font-bold">Select Client</h3>
                    <p className="text-slate-300">Where are you working right now?</p>
                </div>
                <div className="p-4 overflow-y-auto grow">
                  <div className="grid grid-cols-1 gap-3">
                    {clients.map(client => (
                      <button key={client.id} onClick={() => onConfirm(client)} className="flex items-center p-4 bg-slate-50 border hover:border-purple-400 hover:bg-purple-50 rounded-xl text-left transition-all">
                        <div className="w-10 h-10 rounded-full bg-white border flex items-center justify-center mr-3 text-purple-600 font-bold shrink-0">{client.name.charAt(0)}</div>
                        <span className="font-semibold text-slate-700">{client.name}</span>
                        <ChevronRight className="ml-auto text-slate-400" size={20}/>
                      </button>
                    ))}
                    <button onClick={() => onConfirm(null)} className="flex items-center p-4 bg-slate-50 border hover:border-slate-300 rounded-xl justify-center text-slate-500 font-medium">
                      Skip / No Specific Client
                    </button>
                  </div>
                </div>
                <div className="p-4 border-t bg-slate-50 flex justify-center shrink-0">
                    <button onClick={onCancel} className="text-slate-500 font-medium px-6 py-2 hover:bg-slate-200 rounded-lg">Cancel</button>
                </div>
              </div>
            </div>
        );

        // 3. Staff Dashboard (Personal)
        const StaffDashboard = ({ userProfile, clients, shifts, onClockIn, onClockOut }) => {
            const [time, setTime] = useState(new Date());
            const [showClientModal, setShowClientModal] = useState(false);

            useEffect(() => { const t = setInterval(() => setTime(new Date()), 1000); return () => clearInterval(t); }, []);

            // Find my active shift
            const activeShift = shifts.find(s => s.staffId === userProfile.uid && s.status === 'open');
            // Filter my history
            const myHistory = shifts.filter(s => s.staffId === userProfile.uid && s.status === 'closed').sort((a,b) => b.clockInTime?.seconds - a.clockInTime?.seconds).slice(0, 5);

            const handleClockInClick = () => {
                if (clients.length > 0) setShowClientModal(true);
                else onClockIn(null);
            };

            return (
                <div className="max-w-md mx-auto fade-in">
                    {/* Header */}
                    <div className="bg-white rounded-2xl shadow-sm p-6 mb-6">
                        <div className="text-center">
                             <div className="text-6xl font-mono font-bold text-slate-800 tracking-tight mb-2">
                                {time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                             </div>
                             <div className="text-slate-500 font-medium">
                                {time.toLocaleDateString([], { weekday: 'long', day: 'numeric', month: 'long' })}
                             </div>
                        </div>
                    </div>

                    {/* Action Card */}
                    <div className="bg-white rounded-2xl shadow-lg overflow-hidden mb-8 border border-slate-100">
                        <div className={`p-6 text-center ${activeShift ? 'bg-green-50' : 'bg-slate-50'}`}>
                            <div className="w-20 h-20 rounded-full mx-auto mb-4 flex items-center justify-center bg-white shadow-sm text-3xl">
                                {activeShift ? 'ðŸŸ¢' : 'âš«'}
                            </div>
                            <h2 className="text-2xl font-bold text-slate-800 mb-1">
                                {activeShift ? "You are Clocked In" : "Ready to Work?"}
                            </h2>
                            {activeShift && activeShift.clientName && (
                                <div className="inline-block bg-white px-3 py-1 rounded-full text-sm font-medium text-purple-700 shadow-sm mb-2 border border-purple-100">
                                    @ {activeShift.clientName}
                                </div>
                            )}
                            <p className="text-slate-500 text-sm mb-6">
                                {activeShift ? `Started at ${formatTime(activeShift.clockInTime?.toDate())}` : "Record your attendance"}
                            </p>

                            {activeShift ? (
                                <button onClick={() => onClockOut(activeShift)} className="w-full py-4 bg-red-500 hover:bg-red-600 text-white rounded-xl font-bold text-lg shadow-red-200 shadow-lg transition-all flex items-center justify-center gap-2">
                                    <LogOut /> Clock Out
                                </button>
                            ) : (
                                <button onClick={handleClockInClick} className="w-full py-4 bg-slate-900 hover:bg-slate-800 text-white rounded-xl font-bold text-lg shadow-lg transition-all flex items-center justify-center gap-2">
                                    <LogIn /> Clock In
                                </button>
                            )}
                        </div>
                    </div>

                    {/* Recent History */}
                    <div className="bg-white rounded-xl shadow-sm p-4">
                        <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                            <History size={16}/> Recent Shifts
                        </h3>
                        <div className="space-y-3">
                            {myHistory.length === 0 ? <p className="text-slate-400 text-center text-sm py-4">No recent history</p> : null}
                            {myHistory.map(shift => (
                                <div key={shift.id} className="flex justify-between items-center text-sm border-b border-slate-50 pb-2 last:border-0">
                                    <div>
                                        <div className="font-semibold text-slate-700">{formatDate(shift.clockInTime?.toDate())}</div>
                                        <div className="text-slate-400 text-xs">{shift.clientName || 'General'}</div>
                                    </div>
                                    <div className="text-right">
                                        <div className="font-medium text-slate-800">{calculateDuration(shift.clockInTime?.toDate(), shift.clockOutTime?.toDate())}</div>
                                        <div className="text-slate-400 text-xs">{formatTime(shift.clockInTime?.toDate())} - {formatTime(shift.clockOutTime?.toDate())}</div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {showClientModal && (
                        <ClientSelectionModal 
                            clients={clients} 
                            onConfirm={(c) => { setShowClientModal(false); onClockIn(c); }} 
                            onCancel={() => setShowClientModal(false)} 
                        />
                    )}
                </div>
            );
        };

        // 4. Manager Dashboard
        const ManagerDashboard = ({ clients, shifts, users, onAddClient, onDeleteClient, onUpdateUserRole, onDeleteUser }) => {
            const [activeTab, setActiveTab] = useState('overview');
            const [newClientName, setNewClientName] = useState('');

            // Calculations
            const activeShifts = shifts.filter(s => s.status === 'open');
            const sortedHistory = [...shifts].sort((a,b) => (b.clockInTime?.seconds || 0) - (a.clockInTime?.seconds || 0));

            return (
                <div className="bg-white rounded-xl shadow-xl overflow-hidden min-h-[600px] fade-in">
                    {/* Manager Nav */}
                    <div className="bg-slate-900 text-white p-4 flex flex-col sm:flex-row justify-between items-center gap-4">
                        <div className="flex items-center gap-2 font-bold"><ShieldCheck className="text-purple-400"/> Manager Portal</div>
                        <div className="flex bg-slate-800 rounded-lg p-1 overflow-x-auto w-full sm:w-auto">
                            {['overview', 'history', 'clients', 'staff'].map(tab => (
                                <button key={tab} onClick={() => setActiveTab(tab)} className={`px-4 py-1.5 rounded-md text-sm capitalize transition-colors whitespace-nowrap ${activeTab === tab ? 'bg-purple-600 text-white shadow-sm' : 'text-slate-400 hover:text-white'}`}>
                                    {tab}
                                </button>
                            ))}
                        </div>
                    </div>

                    <div className="p-6">
                        {activeTab === 'overview' && (
                            <div className="space-y-6">
                                {/* Live Status */}
                                <div>
                                    <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div> Live Activity</h3>
                                    {activeShifts.length === 0 ? (
                                        <div className="p-8 bg-slate-50 rounded-xl border border-dashed text-center text-slate-500">No staff currently clocked in.</div>
                                    ) : (
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            {activeShifts.map(shift => (
                                                <div key={shift.id} className="p-4 bg-green-50 border border-green-100 rounded-xl flex justify-between items-center">
                                                    <div className="flex items-center gap-3">
                                                        <div className="w-10 h-10 rounded-full bg-white flex items-center justify-center text-green-700 font-bold shadow-sm">
                                                            {shift.staffName.charAt(0)}
                                                        </div>
                                                        <div>
                                                            <div className="font-bold text-slate-800">{shift.staffName}</div>
                                                            <div className="text-xs text-green-700 font-medium">
                                                                {shift.clientName ? `@ ${shift.clientName}` : 'Clocked In'}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div className="text-right">
                                                        <div className="text-slate-500 text-xs">Started</div>
                                                        <div className="font-mono font-medium">{formatTime(shift.clockInTime?.toDate())}</div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {activeTab === 'history' && (
                             <div className="overflow-x-auto border rounded-xl">
                                <table className="w-full text-sm text-left text-slate-600">
                                    <thead className="bg-slate-50 text-xs uppercase font-semibold text-slate-500">
                                        <tr>
                                            <th className="px-6 py-4">Date</th>
                                            <th className="px-6 py-4">Staff</th>
                                            <th className="px-6 py-4">Client</th>
                                            <th className="px-6 py-4">Duration</th>
                                            <th className="px-6 py-4">In / Out</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y">
                                        {sortedHistory.map(shift => (
                                            <tr key={shift.id} className="bg-white hover:bg-slate-50">
                                                <td className="px-6 py-4 font-medium">{formatDate(shift.clockInTime?.toDate())}</td>
                                                <td className="px-6 py-4 text-slate-900 font-semibold">{shift.staffName}</td>
                                                <td className="px-6 py-4">{shift.clientName || '-'}</td>
                                                <td className="px-6 py-4">
                                                    {shift.status === 'open' 
                                                        ? <span className="text-green-600 font-bold text-xs bg-green-100 px-2 py-1 rounded-full">Active</span> 
                                                        : calculateDuration(shift.clockInTime?.toDate(), shift.clockOutTime?.toDate())
                                                    }
                                                </td>
                                                <td className="px-6 py-4 text-xs font-mono text-slate-500">
                                                    {formatTime(shift.clockInTime?.toDate())} - {formatTime(shift.clockOutTime?.toDate())}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}

                        {activeTab === 'clients' && (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div>
                                    <h3 className="font-bold text-slate-800 mb-4">Client List</h3>
                                    <div className="space-y-2 max-h-[400px] overflow-y-auto">
                                        {clients.map(c => (
                                            <div key={c.id} className="p-3 bg-white border rounded-lg flex justify-between items-center shadow-sm">
                                                <div className="flex items-center gap-3">
                                                    <div className="bg-purple-100 p-2 rounded text-purple-600"><Building size={16}/></div>
                                                    <span className="font-medium">{c.name}</span>
                                                </div>
                                                <button onClick={() => onDeleteClient(c.id)} className="text-slate-300 hover:text-red-500 p-2"><Trash2 size={16}/></button>
                                            </div>
                                        ))}
                                        {clients.length === 0 && <p className="text-slate-400 italic">No clients added.</p>}
                                    </div>
                                </div>
                                <div className="bg-slate-50 p-6 rounded-xl h-fit border">
                                    <h3 className="font-bold text-slate-800 mb-4">Add New Client</h3>
                                    <form onSubmit={(e) => { e.preventDefault(); onAddClient(newClientName); setNewClientName(''); }} className="space-y-4">
                                        <input className="w-full border p-3 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none" value={newClientName} onChange={e => setNewClientName(e.target.value)} placeholder="Client Name or Location" required />
                                        <button className="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-lg font-bold shadow-md transition-all">Add Client</button>
                                    </form>
                                </div>
                            </div>
                        )}

                        {activeTab === 'staff' && (
                            <div className="space-y-6">
                                <div>
                                    <h3 className="font-bold text-slate-800 mb-4">Staff Configuration</h3>
                                    <div className="overflow-x-auto border rounded-xl">
                                        <table className="w-full text-sm text-left text-slate-600">
                                            <thead className="bg-slate-50 text-xs uppercase font-semibold text-slate-500">
                                                <tr>
                                                    <th className="px-6 py-4">Name</th>
                                                    <th className="px-6 py-4">Email</th>
                                                    <th className="px-6 py-4">Role</th>
                                                    <th className="px-6 py-4 text-right">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y">
                                                {users.map(u => (
                                                    <tr key={u.uid} className="bg-white hover:bg-slate-50">
                                                        <td className="px-6 py-4 font-medium text-slate-900 flex items-center gap-2">
                                                            <div className="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center text-slate-500 font-bold">{u.name.charAt(0)}</div>
                                                            {u.name}
                                                        </td>
                                                        <td className="px-6 py-4">{u.email}</td>
                                                        <td className="px-6 py-4">
                                                            <span className={`px-2 py-1 rounded text-xs font-bold uppercase ${u.role === 'manager' ? 'bg-purple-100 text-purple-700' : 'bg-slate-100 text-slate-700'}`}>
                                                                {u.role}
                                                            </span>
                                                        </td>
                                                        <td className="px-6 py-4 text-right">
                                                            <div className="flex justify-end gap-2">
                                                                <button 
                                                                    onClick={() => onUpdateUserRole(u.uid, u.role === 'manager' ? 'staff' : 'manager')}
                                                                    className="p-2 text-blue-500 hover:bg-blue-50 rounded"
                                                                    title={u.role === 'manager' ? "Demote to Staff" : "Promote to Manager"}
                                                                >
                                                                    <UserCog size={18}/>
                                                                </button>
                                                                <button 
                                                                    onClick={() => onDeleteUser(u.uid)}
                                                                    className="p-2 text-red-400 hover:bg-red-50 hover:text-red-600 rounded"
                                                                    title="Remove User"
                                                                >
                                                                    <Trash2 size={18}/>
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        function TimeClockApp() {
            const [user, setUser] = useState(null);
            const [userProfile, setUserProfile] = useState(null);
            const [loading, setLoading] = useState(true);
            
            // Data States
            const [clients, setClients] = useState([]);
            const [shifts, setShifts] = useState([]);
            const [allUsers, setAllUsers] = useState([]); // For Manager view
            const [notification, setNotification] = useState(null);

            // Auth Listener
            useEffect(() => {
                if(configError) return;
                
                const unsub = onAuthStateChanged(auth, async (currentUser) => {
                    try {
                        setUser(currentUser);
                        if (currentUser) {
                            // Fetch Role Profile
                            const profileRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUser.uid);
                            try {
                                const snap = await getDoc(profileRef);
                                if (snap.exists()) {
                                    const data = snap.data();
                                    // FORCE ADMIN ROLE for Stacey Sammons
                                    if (data.name && data.name.trim().toLowerCase() === 'stacey sammons') {
                                        data.role = 'manager';
                                    }
                                    setUserProfile(data);
                                } else {
                                    // Fallback if auth exists but firestore profile doesnt
                                    // This handles the transition from Anonymous -> User, or if DB read fails gracefully
                                    const isAnonymous = currentUser.isAnonymous;
                                    const name = currentUser.displayName || (isAnonymous ? 'Guest Staff' : 'Staff');
                                    let role = 'staff';
                                    if (name.trim().toLowerCase() === 'stacey sammons') role = 'manager';

                                    setUserProfile({ 
                                        uid: currentUser.uid, 
                                        name: name, 
                                        role: role 
                                    });
                                }
                            } catch (docError) {
                                console.error("Profile fetch error:", docError);
                                // Fallback on error (e.g. permission denied)
                                setUserProfile({ uid: currentUser.uid, name: currentUser.displayName || 'Staff', role: 'staff' });
                            }
                        } else {
                            setUserProfile(null);
                        }
                    } catch (err) {
                        console.error("Auth state change error:", err);
                    } finally {
                        setLoading(false);
                    }
                });

                // Safety timeout in case auth hangs
                const safetyTimer = setTimeout(() => {
                    setLoading((current) => {
                        if (current) {
                            console.warn("Auth listener timed out, forcing load.");
                            return false;
                        }
                        return current;
                    });
                }, 4000);

                return () => {
                    unsub();
                    clearTimeout(safetyTimer);
                };
            }, []);

            // Data Listeners
            useEffect(() => {
                if (!user) return;
                
                // 1. Clients (Publicly readable usually, or authenticated)
                const unsubClients = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'clients'), 
                    s => setClients(s.docs.map(d => ({id:d.id, ...d.data()})).sort((a,b)=>a.name.localeCompare(b.name))));
                
                // 2. Shifts & Users (Logic depends on Role)
                // Ideally, we'd limit this query for staff, but for simplicity in this file-gen, we fetch and filter in UI
                // In a stricter app, use Firestore Rules + 'where' clauses.
                const unsubShifts = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'time_logs'),
                    s => setShifts(s.docs.map(d => ({id:d.id, ...d.data()}))));

                let unsubUsers = () => {};
                if (userProfile?.role === 'manager') {
                     unsubUsers = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'),
                        s => setAllUsers(s.docs.map(d => ({id:d.id, ...d.data()}))));
                }

                return () => { unsubClients(); unsubShifts(); unsubUsers(); };
            }, [user, userProfile]);

            // Actions
            const notify = (msg, type='neutral') => { setNotification({msg, type}); setTimeout(() => setNotification(null), 3000); };

            const handleClockIn = async (client) => {
                if (!user || !userProfile) return;
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'time_logs'), { 
                        staffId: user.uid, 
                        staffName: userProfile.name, 
                        clientId: client?.id || null, 
                        clientName: client?.name || null, 
                        clockInTime: serverTimestamp(), 
                        clockOutTime: null, 
                        status: 'open' 
                    });
                    notify("You are clocked in!", "success");
                } catch(e) { console.error(e); notify("Error clocking in", "error"); }
            };

            const handleClockOut = async (shift) => {
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'time_logs', shift.id), { 
                        clockOutTime: serverTimestamp(), 
                        status: 'closed' 
                    });
                    notify("Clocked out successfully");
                } catch(e) { console.error(e); notify("Error clocking out", "error"); }
            };

            const handleAddClient = async (name) => {
                if(userProfile?.role !== 'manager') return;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'clients'), { name });
                notify("Client added");
            };

            const handleDeleteClient = async (id) => {
                if(userProfile?.role !== 'manager') return;
                if(confirm("Delete this client?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'clients', id));
            };

            const handleUpdateUserRole = async (targetUid, newRole) => {
                if(userProfile?.role !== 'manager') return;
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', targetUid), {
                        role: newRole
                    });
                    notify(`User updated to ${newRole}`, "success");
                } catch (e) { console.error(e); notify("Error updating role", "error"); }
            };

            const handleDeleteUser = async (targetUid) => {
                if(userProfile?.role !== 'manager') return;
                if(confirm("Remove this user? They will lose access details.")) {
                    try {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', targetUid));
                        notify("User removed", "neutral");
                    } catch (e) { console.error(e); notify("Error removing user", "error"); }
                }
            };

            const handleLogout = async () => {
                await signOut(auth);
                notify("Logged out");
            };


            // Views
            if (configError) return <div className="h-screen flex items-center justify-center bg-red-50 text-red-600 p-8 text-center"><b>Configuration Error</b><br/>Please edit index.html and add your Firebase Config keys.</div>;
            
            if (loading) return <div className="h-screen flex items-center justify-center text-slate-400">Loading Portal...</div>;

            if (!user) return <AuthScreen />;

            return (
                <div className="min-h-screen bg-slate-100 font-sans text-slate-900 pb-12">
                     {/* Notification */}
                     {notification && (
                        <div className={`fixed top-4 left-1/2 -translate-x-1/2 z-[100] px-6 py-3 rounded-full shadow-xl flex items-center gap-2 text-white font-medium ${notification.type==='success'?'bg-green-600': notification.type==='error'?'bg-red-600':'bg-slate-800'}`}>
                            {notification.msg}
                        </div>
                    )}

                    {/* App Header */}
                    <div className="bg-white border-b sticky top-0 z-10">
                        <div className="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
                             <div className="flex items-center gap-2">
                                <img src="logo.png" className="h-8 w-auto" onError={(e) => e.target.style.display='none'} />
                                <span className="font-bold text-purple-900 hidden sm:block">May We Care</span>
                             </div>
                             <div className="flex items-center gap-4">
                                <div className="text-right hidden sm:block">
                                    <div className="text-sm font-bold text-slate-800">{userProfile?.name}</div>
                                    <div className="text-xs text-slate-500 uppercase tracking-wide">{userProfile?.role}</div>
                                </div>
                                <button onClick={handleLogout} className="text-sm text-red-500 font-medium hover:bg-red-50 px-3 py-1.5 rounded-lg transition-colors">
                                    Sign Out
                                </button>
                             </div>
                        </div>
                    </div>

                    {/* Main Content */}
                    <div className="max-w-6xl mx-auto px-4 py-8">
                        {!userProfile ? (
                            <div className="text-center py-20">Setting up your profile...</div>
                        ) : userProfile.role === 'manager' ? (
                            <ManagerDashboard 
                                clients={clients} 
                                shifts={shifts} 
                                users={allUsers}
                                onAddClient={handleAddClient} 
                                onDeleteClient={handleDeleteClient}
                                onUpdateUserRole={handleUpdateUserRole}
                                onDeleteUser={handleDeleteUser}
                            />
                        ) : (
                            <StaffDashboard 
                                userProfile={userProfile} 
                                clients={clients} 
                                shifts={shifts} 
                                onClockIn={handleClockIn} 
                                onClockOut={handleClockOut} 
                            />
                        )}
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<TimeClockApp />);
    </script>
</body>
</html>